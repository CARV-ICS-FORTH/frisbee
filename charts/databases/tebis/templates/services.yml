---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: tebis.cluster.zookeeper
spec:
  service:
    decorators:
      telemetry: [ system.telemetry.agent]
    containers:
      - name: app
        image: zookeeper:3.5.9
        ports:
          - name: peerport
            containerPort: 2888
          - name: leaderport
            containerPort: 3888
          - name: clientport
            containerPort: 2181
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum

            echo "Initiate Zookeeper at 0.0.0.0:2181"
            /docker-entrypoint.sh zkServer.sh start-foreground


---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: tebis.cluster.bootstrap
spec:
  inputs:
    parameters:
      zookeeper: localhost
      serverHost: "localhost"
      serverPort: "6060"
  service:
    decorators:
      telemetry: [ system.telemetry.agent]
    containers:
      - name: app
        image: icsforth/tebis-init:latest
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum

            echo "Create hosts file"
            cat > hosts <<EOF
              masters-1:6060 leader
              masters-2:6061
              masters-3:6062
            EOF

            echo "Create regions file"
            cat > regions <<EOF
              0 -oo AB masters-1:6060
              1 AB AC masters-2:6061
              2 AC +oo masters-3:6062
            EOF

            zookeeper={{"{{.inputs.parameters.zookeeper}}:2181"}}

            sleep 60

            echo "Contact Zookeeper at ${zookeeper}"
            python /tebis_zk_init.py hosts regions ${zookeeper}

            echo "Regions have been successfully created"


---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: tebis.cluster.master
spec:
  inputs:
    parameters:
      zookeeper: localhost
      device: "/tmp/tebis.dat"
      port: "6060"
  service:
    decorators:
      telemetry: [ system.telemetry.agent]
#      annotations:
#        k8s.v1.cni.cncf.io/networks: macvlan-rdma
#      telemetry: [ system.telemetry.agent ]
      setFields:
        - field: PodSpec.Containers.0.Ports.0.ContainerPort
          value: {{"{{.inputs.parameters.port | int}}" | quote}}
    containers:
      - name: app
        image: icsforth/tebis-node:latest
        ports:
          - name: to-clients
            containerPort: 0 # Will be populated by set field
        securityContext:
          privileged: true
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            cut -d ' ' -f 4 /proc/self/stat > /dev/shm/app # Sidecar: use it for entering the cgroup

            device={{"{{.inputs.parameters.device}}"}}
            zookeeper={{"{{.inputs.parameters.zookeeper}}"}}
            port={{"{{.inputs.parameters.port}}"}}
            cores="0,1,2"

            rdma=$(hostname -I)

            echo "RDMA " ${rdma}
            sleep infinity

            echo "Pre-allocate space for Tebis server"
            fallocate --length 16G ${device}

            echo "Starting Tebis server"
            echo ./kreon_server/kreon_server ${device} ${zookeeper}:2181 ${rdma} 65536 8 send_index ${port},${cores}
            ./kreon_server/kreon_server ${device} ${zookeeper}:2181 ${rdma} 65536 8 send_index ${port},${cores}


---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: tebis.cluster.client
spec:
  inputs:
    parameters:
      zookeeper: localhost
      scenario: "./ycsb_execution_plans/execution_plan_la.txt"
      threads: "4"
      regions: "1"
  service:
    decorators:
      telemetry: [ system.telemetry.agent]
#      annotations:
#        k8s.v1.cni.cncf.io/networks: macvlan-rdma
    containers:
      - name: app
        image:  icsforth/tebis-node:latest
        securityContext:
          privileged: true
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            cut -d ' ' -f 4 /proc/self/stat > /dev/shm/app # Sidecar: use it for entering the cgroup

            echo "Starting Tebis client"

            cd /build/tebis/build/YCSB-CXX

             ./ycsb-async-kreon                               \
            -e {{"{{.inputs.parameters.scenario}}"}}          \
            -threads {{"{{.inputs.parameters.threads}}"}}     \
            -dbnum 1                                          \
            -w sd                                             \
            -zookeeper  {{"{{.inputs.parameters.zookeeper}}"}}:2181