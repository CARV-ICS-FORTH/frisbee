---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: cockroach.single.master
spec:
  service:
    decorators:
      telemetry:
        - system.telemetry.agent
        - cockroach.telemetry.server

    callables:
      drain:
        container: app
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            cockroach node drain --insecure --host $(hostname)

    containers:
      - name: main
        image: cockroachdb/cockroach:v21.2.4
        ports:
          - name: grpc
            containerPort: {{.Values.port | int64}}
          - name: http
            containerPort: {{ .Values.httpPort | int64 }}
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            cut -d ' ' -f 4 /proc/self/stat > /dev/shm/app # Sidecar: use it for entering the cgroup

            echo "Start Cockroachdb"
            cockroach start-single-node                   \
                --insecure                                \
                --store=$${HOSTNAME}                      \
                --listen-addr=$${HOSTNAME}:26257          \
                --http-addr=$${HOSTNAME}:8080

        startupProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 5
          failureThreshold: 30
          periodSeconds: 10

        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5