---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: parallax.ycsb
spec:
  inputs: # get a test name
    parameters:
      test: simple_test_delete
      volumeSize: 1Gi

  service:
    decorators: # Monitoring the resources consumed by the test
      telemetry: [ system.telemetry.agent ]

    volumes: # Create an ephemeral volume for the testdata
      - name: scratch-volume
        ephemeral:
          volumeClaimTemplate:
            spec:
              storageClassName: platform.storageclass.local
              volumeMode: Filesystem
              accessModes: [ReadWriteOnce]
              resources:
                requests:
                  storage: {{"{{.inputs.parameters.volumeSize}}"}}

    containers:
      - name: main
        image: gxanth/parallax:beta
        volumeMounts:
          - name: scratch-volume
            mountPath: /tmp/test
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            cut -d ' ' -f 4 /proc/self/stat > /dev/shm/app # Sidecar: use it for entering the cgroup

            cd /parallax/build
            ctest -R {{"{{.inputs.parameters.test}}"}} --verbose
            sleep infinity