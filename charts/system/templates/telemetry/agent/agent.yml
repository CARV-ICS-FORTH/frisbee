---
# The problem of running cadvisor as a sidecar is that the sidecar gets its own cgroup.
# https://d2iq.com/blog/running-kind-inside-a-kubernetes-cluster-for-continuous-integration


# https://grafana.com/docs/agent/latest/configuration/integrations/cadvisor-config/
# https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md

# https://pracucci.com/kubernetes-dns-resolution-ndots-options-and-why-it-may-affect-application-performances.html
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: system.telemetry.agent
spec:
  service:
    containers:
      - name: cadvisor
        image: gcr.io/cadvisor/cadvisor:v0.44.0
        ports:
          - name: tel-sys
            containerPort: 9442
        securityContext:
          privileged: true
          #capabilities:
          #add: [ SYS_ADMIN, SYS_CHROOT, MKNOD, SETFCAP ]
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str
            set -eum

            # Needed to fix DNS issues
            echo "$( cat /etc/resolv.conf | sed 's/ndots:5/ndots:1/')"  >  /etc/resolv.conf


            # Add a newer version of nsenter that supports cgroup
            apk add util-linux --no-cache

            # Wait a bit to obtain the PID of the main container
            while [ ! -f "/dev/shm/app" ];
            do
              sleep 3
            done

            # Unmount the local cgroup
            umount /sys/fs/cgroup

            # Tap into the cgroup of the main container, and mount it locally
            nsenter -t $(cat /dev/shm/app) -C -- mount -t cgroup2 none /sys/fs/cgroup


            cadvisor --port=9442                  \
            --docker_only=true                   \
            --store_container_labels=false        \
            --log_cadvisor_usage=false            \
            --profiling=false                     \
            --allow_dynamic_housekeeping=true     \
            --housekeeping_interval=2s            \
            --disable_root_cgroup_stats=false     \
            --disable_metrics=advtcp,cpuLoad,cpu_topology,cpuset,hugetlb,memory_numa,process,referenced_memory,resctrl,sched,percpu,process,perf_event,tcp,udp  \
            --enable_metrics=cpu,memory,disk,diskIO,network,accelerator,oom_event \
            &


            while [ ! -f "/dev/shm/stop" ];
            do
              sleep 10
            done


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: system.telemetry.agent.config
data: {{(.Files.Glob "dashboards/*.json").AsConfig | nindent 2}}
