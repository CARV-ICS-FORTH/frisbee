---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: default.telemetry.logviewer
spec:
  inputs:
    parameters:
      logClaimName: ""

  service:
    requirements:
      ingressBackend:
        service:
          name: self
          port:
            number: {{.Values.logviewer.port}}

    decorators:
      labels:
        scenario.frisbee.dev/component: SYS

    volumes: # Match the pod to the log volume
      - name: logs
        persistentVolumeClaim:
          claimName: {{"{{.Inputs.Parameters.logClaimName}}" | quote}}

    # Do a nasty touch to sync/populate the volume.
    initContainers:
      - name: wait-for-volume
        image: busybox
        volumeMounts:
          - name: logs
            mountPath: /srv
        command: [ "touch", "/srv/init" ]

    containers: # Expose collected logs
      - name: app
        image: filebrowser/filebrowser
        ports:
          - name: http
            containerPort: {{.Values.logviewer.port}}
        volumeMounts:
          - name: logs
            mountPath: /srv
