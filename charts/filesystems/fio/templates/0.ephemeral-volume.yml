# Add monitoring # https://github.com/fritchie/fio_benchmark_exporter
---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: fio.benchmark.ephemeral
spec:
  inputs:
    parameters:
      size: "10M"
      direct: "0"
      ioengine: libaio
  service:
    decorators: # decorators
      telemetry:
        - system.telemetry.agent

    volumes:   # Create an ephemeral volume, backed by a file
      - name: scratch-volume
        ephemeral:
          volumeClaimTemplate:
            spec:
              storageClassName: local-volume
              volumeMode: Filesystem
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 500Mi

    containers: # Container
      - name: app
        image: xridge/fio
        volumeMounts:
          - name: scratch-volume
            mountPath: /scratch
        command:
          - /bin/sh # Run shell
          - -c      # Read from string
          - |       # Multi-line str
            set -eum
            cut -d ' ' -f 4 /proc/self/stat > /dev/shm/app # Sidecar: use it for entering the cgroup

            DEVICE=/scratch
            SIZE={{"{{.Inputs.Parameters.size}}"}}
            DIRECT={{"{{.Inputs.Parameters.direct}}"}}
            IOENGINE={{"{{.Inputs.Parameters.ioengine}}"}}

            echo "USING DEVICE: $DEVICE"

            {{ range .Files.Lines "scripts/fio.sh" }}
            {{ . }}
            {{ end }}