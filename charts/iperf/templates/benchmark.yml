---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: iperf.server
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
spec:
  inputs:
    parameters:
      memory: ""
      cpu: ""
  service:
    agents: # Agents
      telemetry: [ platform.telemetry.container ]
    resources: # Resources
      cpu: {{"{{.Inputs.Parameters.cpu}}" | quote}}
      memory: {{"{{.Inputs.Parameters.memory}}" | quote}}
    container: # Container
      name: app
      image: "networkstatic/iperf3"
      ports:
        - name: tcp
          containerPort: 5201
      args: [ "-s", "-f", "m" ]



---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: iperf.client
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
spec:
  inputs:
    parameters:
      server: localhost
      memory: ""
      cpu: ""
      seconds: "60"
  service:
    agents:
      telemetry: [ platform.telemetry.container, iperfmon.client ]
    resources:
      memory: {{"{{.Inputs.Parameters.memory}}" | quote}}
      cpu: {{"{{.Inputs.Parameters.cpu}}" | quote}}
    container:
      name: app
      image: "networkstatic/iperf3"
      ports:
        - name: tcp
          containerPort: 5201
      command:
        - /bin/sh # Run shell
        - -c # Read from string
        - |  # Multi-line str
          set -eum
          trap "touch /dev/shm/stop" EXIT

          server={{"{{.Inputs.Parameters.server}}"}}

          iperf3 -c ${server} -t {{"{{.Inputs.Parameters.seconds}}"}} -f m > /dev/shm/pipe
