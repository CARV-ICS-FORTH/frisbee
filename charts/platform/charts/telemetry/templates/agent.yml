---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: platform.telemetry.container
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
spec:
  monitor:
    agent:
      container:
        name: cadvisor
        image: gcr.io/cadvisor/cadvisor
        ports:
          - name: mon-system
            containerPort: 9442
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str
            set -eum

            # https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md
            cadvisor -port=9442  &
            # -enable_metrics=diskIO,cpuLoad,hugetlb,memory,network

            while [ ! -f "/dev/shm/stop" ];
            do
              sleep 10
            done

    dashboards:
      matchLabels:
        dashboard: sysmon


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-system-container
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
    dashboard: sysmon
data: {{(.Files.Glob "dashboards/syscontainer.json").AsConfig | nindent 2}}
