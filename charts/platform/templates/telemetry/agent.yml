---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: platform.telemetry.container
spec:
  service:
    decorators:
      dashboards:
        matchLabels:
          dashboard: sysmon
    containers:
      - name: cadvisor
        image: gcr.io/cadvisor/cadvisor:v0.44.0
        ports:
          - name: mon-system
            containerPort: 9442
        securityContext:
          #runAsNonRoot: true
          #readOnlyRootFilesystem: false
          #allowPrivilegeEscalation: false
          privileged: true
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str
            set -eum

            # https://grafana.com/docs/agent/latest/configuration/integrations/cadvisor-config/
            # https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md

            cadvisor --port=9442                  \
            --docker_only=true                   \
            --store_container_labels=false        \
            --log_cadvisor_usage=false            \
            --profiling=false                     \
            --allow_dynamic_housekeeping=true     \
            --housekeeping_interval=2s            \
            --disable_root_cgroup_stats=false     \
            --disable_metrics=advtcp,cpuLoad,cpu_topology,cpuset,hugetlb,memory_numa,process,referenced_memory,resctrl,sched,percpu,process,perf_event,tcp,udp  \
            --enable_metrics=cpu,memory,disk,diskIO,network,accelerator,oom_event \
            &


            while [ ! -f "/dev/shm/stop" ];
            do
              sleep 10
            done


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-system-container
  labels:
    dashboard: sysmon
data: {{(.Files.Glob "dashboards/*.json").AsConfig | nindent 2}}
