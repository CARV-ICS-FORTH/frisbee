---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: platform.telemetry.container

spec:
  service:
    decorators:
      dashboards:
        matchLabels:
          dashboard: sysmon
    containers:
      - name: cadvisor
        image: gcr.io/cadvisor/cadvisor:v0.44.0
        ports:
          - name: mon-system
            containerPort: 9442
        securityContext:
          privileged: true
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str
            set -eum

            # https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md
            cadvisor --port=9442                  \
            --docker_only=false                   \
            --allow_dynamic_housekeeping=true     \
            --housekeeping_interval=10s           \
            --disable_metrics=advtcp,cpuLoad,cpu_topology,cpuset,hugetlb,memory_numa,process,referenced_memory,resctrl,sched,tcp,udp,percpu,process,perf_event,oom_event  \
            --enable_metrics=accelerator,cpu,memory,disk,diskIO,network,app \
            &


            while [ ! -f "/dev/shm/stop" ];
            do
              sleep 10
            done


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-system-container
  labels:
    dashboard: sysmon
data: {{(.Files.Glob "dashboards/*.json").AsConfig | nindent 2}}
