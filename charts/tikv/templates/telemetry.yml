---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: tikv.telemetry.pd
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
spec:
  service:
    decorators:
      dashboards:
        matchLabels:
          dashboard: tikv
          specificTo: pd

    containers:
      - name: telegraf
        image: telegraf:1.20.3
        ports:
          - name: mon-pd
            containerPort: 9443
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str
            set -eum

            # Read metrics from one or many prometheus clients.
            # See https://github.com/influxdata/telegraf/blob/master/plugins/inputs/prometheus/README.md

            cat > /tmp/prometheus.conf <<EOF
            [[inputs.prometheus]]
               ## An array of urls to scrape metrics from.
               urls = [
                  "http://localhost:2379/metrics"
              ]

              metric_version = 2

            [[outputs.prometheus_client]]
               listen = ":9443"
               metric_version = 2
               export_timestamp = true
               collectors_exclude = ["gocollector","process"]
            EOF

            telegraf --config /tmp/prometheus.conf &

            # When the stop file is added by the container, the process stop
            while [ ! -f "/dev/shm/stop" ];
            do
              sleep 10
            done




---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: tikv.telemetry.worker
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
spec:
  service:
    decorators:
      dashboards:
        matchLabels:
          dashboard: tikv
          specificTo: worker

    containers:
      - name: telegraf
        image: telegraf:1.20.3
        ports:
          - name: mon-tikv
            containerPort: 9443
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str
            set -eum

            # Read metrics from one or many prometheus clients.
            # See https://github.com/influxdata/telegraf/blob/master/plugins/inputs/prometheus/README.md

            cat > /tmp/prometheus.conf <<EOF
            [[inputs.prometheus]]
               ## An array of urls to scrape metrics from.
               urls = [
                  "http://localhost:20180/metrics"
              ]

              metric_version = 2

            [[outputs.prometheus_client]]
               listen = ":9443"
               metric_version = 2
               export_timestamp = true
               collectors_exclude = ["gocollector","process"]
            EOF

            telegraf --config /tmp/prometheus.conf &

            # When the stop file is added by the container, the process stop
            while [ ! -f "/dev/shm/stop" ];
            do
              sleep 10
            done


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-tikv-summary
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
    dashboard: tikv
    specificTo: worker
data: {{(.Files.Glob "dashboards/tikv-summary.json").AsConfig | nindent 2}}


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-tikv-pd
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
    dashboard: tikv
    specificTo: pd
data: {{(.Files.Glob "dashboards/tikv-pd.json").AsConfig | nindent 2}}


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-tikv-raw
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
    dashboard: tikv
    specificTo: worker
data: {{(.Files.Glob "dashboards/tikv-raw.json").AsConfig | nindent 2}}


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-tikv-troubleshooting
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
    dashboard: tikv
    specificTo: worker
data: {{(.Files.Glob "dashboards/tikv-troubleshooting.json").AsConfig | nindent 2}}
