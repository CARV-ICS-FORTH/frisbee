---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: fedbed.server
spec:
  inputs:
    parameters:
      min_eval_clients: 2
      min_fit_clients: 2
      min_available_clients: 2
  service:
    containers:
      - name: app
        image: icsforth/fedbed:latest
        env:
          - name:  FL_STRATEGY
            value: FedAvg
          - name:  FL_NUM_OF_ROUNDS
            value: "5"
          - name:  FL_FRACTION_FIT
            value: "0.1"
          - name:  FL_FRACTION_EVAL
            value: "0.1"
          - name:  FL_MIN_EVAL_CLIENTS
            value: {{"{{.inputs.parameters.min_eval_clients}}" | quote}}
          - name:  FL_MIN_FIT_CLIENTS
            value: {{"{{.inputs.parameters.min_fit_clients}}" | quote }}
          - name:  FL_MIN_AVAILABLE_CLIENTS
            value: {{"{{.inputs.parameters.min_available_clients}}" | quote}}
          - name:  FL_EVAL_DATASET
            value: "false"
          - name:  FL_DATASET
            value: "CIFAR100"
          - name:  FL_TRAINING_SET_SIZE
            value: "50_000"
          - name:  FL_TEST_SET_SIZE
            value: "50_000"
        ports:
          - name: http
            containerPort: 8080

        command: ["/bin/sh", "-c"]
        args:
          - | # Script
            set -eux

            python server.py

            sleep infinity


---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: fedbed.client
spec:
  inputs:
    parameters:
      fl_server: "server"
      dataset: "fl.dataset.cifar10"
      backend: "pytorch"

      total_nodes: 10
      node_id: 0
  service:
    volumes:
      - name: dataset
        persistentVolumeClaim:
          claimName: {{"{{.inputs.parameters.dataset}}" | quote}}

    containers:
      - name: app
        image: icsforth/fedbed:latest
        volumeMounts:
          - name: dataset
            mountPath: /data/{{"{{.inputs.parameters.backend}}"}}/cifar10
        env:
          - name:  FL_SERVER
            value: {{"{{.inputs.parameters.fl_server}}" | quote }}

          - name:  FL_BACKEND
            value: pytorch
          - name:  FL_NUM_OF_THREADS
            value: "1"

          # Are these values really neeeded here?
          - name:  FL_NODES
            value: {{"{{.inputs.parameters.total_nodes}}" | quote}}
          - name:  FL_NODE_ID
            value: {{"{{.inputs.parameters.node_id}}" | quote}}
          - name:  FL_DATASET_DISTRIBUTION
            value: "flat"
          - name:  FL_DATASET_DISTRIBUTION_PARAMETERS
            value: "{}"
          - name:  FL_DATASET_RANDOM
            value: "false"

          - name: SKATA
            value: {{"{{ (.inputs.parameters.dataset) }}" | quote}}

          - name: SKATA1
            value: {{"{{ (base .inputs.parameters.dataset) }}" | quote}}

          - name: SKATA2
            value: {{"{{ (osBase .inputs.parameters.dataset) }}" | quote}}

          - name: SKATA3
            value: {{"{{ (.inputs.parameters.dataset | base) }}" | quote}}

          - name: SKATA4
            value: {{"{{ (.inputs.parameters.dataset | osBase) }}" | quote}}

        command: ["/bin/sh", "-c"]
        args:
          - | # Script
            set -eux

            # do it like that until I find a better way to go from fl.dataset.cifar10 to cifar10.
            FL_DATASET=$(basename {{"{{.inputs.parameters.dataset}}"}})

            tail -f /dev/null

