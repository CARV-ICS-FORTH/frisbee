---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: fedbed.server
spec:
  inputs:
    parameters:
      min_fit_clients: 1
      min_available_clients: 1
      rounds: 5

      # should be used with FL_EVAL_DATASET
      dataset_eval: "true"
      dataset: "MNIST"
      backend: "pytorch"
  service:
    decorators:
      telemetry:
        - system.telemetry.resources

    containers:
      - name: main
        image: icsforth/fedbed:latest
        imagePullPolicy: IfNotPresent
        env:
          - name: FL_STRATEGY
            value: FedAvg
          - name: FL_NUM_OF_ROUNDS
            value: {{"{{.inputs.parameters.rounds}}" | quote}}

          - name: FL_FRACTION_FIT
            value: "0.1"
          - name: FL_FRACTION_EVAL
            value: "0.1"
          - name: FL_MIN_EVAL_CLIENTS
            value: {{"{{.inputs.parameters.min_available_clients}}" | quote}}
          - name: FL_MIN_FIT_CLIENTS
            value: {{"{{.inputs.parameters.min_fit_clients}}" | quote }}
          - name: FL_MIN_AVAILABLE_CLIENTS
            value: {{"{{.inputs.parameters.min_available_clients}}" | quote}}

          - name: FL_EVAL_DATASET
            value: {{"{{.inputs.parameters.dataset_eval}}" | quote}}
          - name: FL_DATASET
            value: {{"{{.inputs.parameters.dataset}}" | quote}}
          - name: FL_BACKEND
            value: {{"{{.inputs.parameters.backend}}" | quote }}
        ports:
          - name: http
            containerPort: 8080

        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eux
            cut -d ' ' -f 4 /proc/self/stat > /dev/shm/app # Sidecar: use it for entering the cgroup

            python server.py