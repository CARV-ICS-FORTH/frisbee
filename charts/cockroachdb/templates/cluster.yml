---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: cockroach.cluster.master
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
spec:
  inputs:
    parameters:
      join: ""
  service:
    decorators:
      telemetry:
        - platform.telemetry.container
        - cockroach.telemetry.server

    containers:
      - name: app
        image: cockroachdb/cockroach:latest
        ports:
          - name: grpc
            containerPort: {{.Values.port | int64}}
          - name: http
            containerPort: {{ .Values.httpPort | int64 }}
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            trap "touch /dev/shm/stop" EXIT


              echo "Start Cockroachdb: {{"{{.Inputs.Parameters.join}}"}}"

              cockroach start                                     \
                --insecure                                        \
                --store=$${HOSTNAME}                              \
                --listen-addr=$${HOSTNAME}:{{.Values.port}}                  \
                --http-addr=$${HOSTNAME}:{{.Values.httpPort}}                     \
                --join={{"{{.Inputs.Parameters.join}}"}}


        startupProbe:
          httpGet:
            path: /health
            port: http
          failureThreshold: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5


---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: cockroach.cluster.bootstrap
  labels:
    app.kubernetes.io/managed-by: {{.Release.Service | quote}}
spec:
  inputs:
    parameters:
      server: localhost
      port: "26257"
  service:
    containers:
      - name: app
        image: cockroachdb/cockroach:latest
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum

            addr={{"{{.Inputs.Parameters.server}}"}}:{{"{{.Inputs.Parameters.port}}"}}

            echo "Initiate cluster using $addr"

            cockroach init --insecure --host=$addr
