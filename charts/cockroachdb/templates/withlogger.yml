---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: cockroach.cluster.master-with-logger
spec:
  inputs:
    parameters:
      join: ""
      storedir: "cockroach-data"
      logClaimName: ""

  service:
    decorators:
      telemetry:
        - system.telemetry.agent
        - cockroach.telemetry.server

    volumes: # Match the pod to the log volume
      - name: logs
        persistentVolumeClaim:
          claimName: {{"{{.Inputs.Parameters.logClaimName}}" | quote}}

    initContainers:
      - name: wait-for-sync
        image: busybox
        volumeMounts: # Mount the log volume
          - name: logs
            mountPath: /logs
        command: [ "ls", "/logs" ]

    containers:
      - name: app
        image: cockroachdb/cockroach:latest
        volumeMounts: # Mount the log volume
          - name: logs
            mountPath: /logs
        ports:
          - name: grpc
            containerPort: {{.Values.port | int64}}
          - name: http
            containerPort: {{ .Values.httpPort | int64 }}
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            cut -d ' ' -f 4 /proc/self/stat > /dev/shm/app # Sidecar: use it for entering the cgroup
            trap "touch /dev/shm/stop" EXIT # Sidecar: use it to terminate itself when this container has exit.

            # Required for installing xargs
            microdnf install findutils procps nc

            # Set local variables
            storedir={{"{{.Inputs.Parameters.storedir}}"}}
            nodeList={{"{{.Inputs.Parameters.join}}"}}

            echo "Start Cockroachdb: ${nodeList}"
            # Because the log volume is shared with other services,
            # we use the name of the pod as prefix

            COCKROACH_CRASH_ON_SPAN_USE_AFTER_FINISH=true cockroach start   \
                --insecure                                      \
                --store=${storedir}                             \
                --listen-addr=:{{.Values.port}}                            \
                --http-addr=$${HOSTNAME}:{{.Values.httpPort}}                   \
                --advertise-addr=$${HOSTNAME}:{{.Values.port}}             \
                --join=${nodeList} &> /logs/${HOSTNAME}


    # Albeit it is possible to log the callables, the Pod name is not available at this level,
    # and therefore it is difficult to place them into the proper log hierarchy. Instead, the output
    # of the callables should be available by the controller who calls them.
    callables:
      boot:
        container: app
        command:
          - /bin/sh
          - -c
          - |
            # Use a retry logic here
            for i in {1..3}; do
              echo "(re)try to boot the cluster";

              cockroach init --insecure && break || sleep 15;
            done

      import-tpcc:
        container: app
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            ./cockroach workload fixtures import tpcc --warehouses=100 --fks=false --checks=false

      bitrot:
        container: app
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -euo pipefail

            # Set local variables
            storedir={{"{{.Inputs.Parameters.storedir}}"}}
            nTables=6

            # find 6 random SST files on each node (abort if node has fewer)
            SSTs=($(ls -tr ${storedir}/MANIFEST-* | tail -n1 |                            \
            xargs ./cockroach debug pebble manifest dump |                                \
            grep -v added | grep -v deleted | grep '/Table/' |                            \
            shuf | tail -n ${nTables}))

            # abort if we have less than 6
            if (( ${#SSTs[@]} < ${nTables} )); then
              echo "No sufficient SSTs found" >&2
              # ... The rest of the debugging logic ...
              exit -1
            fi

            # corrupt the SSTs
            for i in "${SSTs[@]}"
            do
              file=${storedir}/$(echo $i | cut -d ':' -f 1)
              echo "Corrupting ${file}.sst"

              dd if=/dev/urandom of=${file}.sst seek=256 count=128 bs=1 conv=notrunc
            done

      run-workload:
        container: app
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            ./cockroach workload run tpcc --warehouses=100 --tolerate-errors
