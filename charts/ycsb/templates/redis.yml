---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: ycsb.redis.loader
spec:
  inputs:
    parameters:
      server: localhost
      port: "6379"
      mode: "single"
      offset: "0"
      recordcount: "1000000"
      cpu: ""     # Example: 8
      memory: ""  # Example: 8Gi
      threads: "1"
      workload: "workloada"
      dropdata: "false"
      delay: "0"
  service:
    decorators: # Decorators
      telemetry:
        - system.telemetry.agent
        - ycsb.telemetry.client
      resources: # Resources
        cpu: {{"{{.Inputs.Parameters.cpu}}" |quote}}
        memory: {{"{{.Inputs.Parameters.memory}}" |quote}}

    containers: # Container(s)
      - name: app
        image: aylei/go-ycsb:20201029
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            cut -d ' ' -f 4 /proc/self/stat > /dev/shm/app # Sidecar: use it for entering the cgroup
            trap "touch /dev/shm/stop" EXIT # Sidecar: use it to terminate itself when this container has exit.

            addr={{"{{.Inputs.Parameters.server}}"}}:{{"{{.Inputs.Parameters.port}}"}}

            echo "Loader: $addr <- {{"{{.Inputs.Parameters.recordcount}}"}}:{{"{{.Inputs.Parameters.offset}}"}}"

            sleep {{"{{.Inputs.Parameters.delay}}"}}

            ./go-ycsb load redis                                     \
                -P workloads/{{"{{.Inputs.Parameters.workload}}"}}         \
                -p dropdata={{"{{.Inputs.Parameters.dropdata}}"}}          \
                -p recordcount={{"{{.Inputs.Parameters.recordcount}}"}}    \
                -p insertstart={{"{{.Inputs.Parameters.offset}}"}}         \
                -p threadcount={{"{{.Inputs.Parameters.threads}}"}}        \
                -p redis.mode={{"{{.Inputs.Parameters.mode}}"}}            \
                -p redis.addr=${addr}                                \
            >> /dev/shm/pipe

---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: ycsb.redis.runner
spec:
  inputs:
    parameters:
      server: localhost
      port: "6379"
      mode: "single"
      workload: "workloada"
      operationcount: "30000000"
      cpu: "8"
      memory: "8Gi"
      threads: "1"
  service:
    decorators: # Decorators
      telemetry:
        - system.telemetry.agent
        - ycsb.telemetry.client
      resources: # Resources
        cpu: {{"{{.Inputs.Parameters.cpu}}" |quote}}
        memory: {{"{{.Inputs.Parameters.memory}}" |quote}}

    containers: # Container(s)
      - name: app
        image: aylei/go-ycsb:20201029
        command:
          - /bin/sh   # Run shell
          - -c        # Read from string
          - |         # Multi-line str
            set -eum
            cut -d ' ' -f 4 /proc/self/stat > /dev/shm/app # Sidecar: use it for entering the cgroup
            trap "touch /dev/shm/stop" EXIT # Sidecar: use it to terminate itself when this container has exit.

            addr={{"{{.Inputs.Parameters.server"}}}}:{{"{{.Inputs.Parameters.port}}"}}

            echo "Runner: $addr <- {{"{{.Inputs.Parameters.workload}}"}}:{{"{{.Inputs.Parameters.operationcount}}"}}"

            ./go-ycsb run redis                                             \
                  -P workloads/{{"{{.Inputs.Parameters.workload}}"}}              \
                  -p operationcount={{"{{.Inputs.Parameters.operationcount}}"}}   \
                  -p threadcount={{"{{.Inputs.Parameters.threads}}"}}             \
                  -p redis.mode={{"{{.Inputs.Parameters.mode}}"}}                 \
                  -p redis.addr=${addr}                                     \
            >> /dev/shm/pipe
