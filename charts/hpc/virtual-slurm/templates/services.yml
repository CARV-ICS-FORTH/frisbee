---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: slurm-master
spec:
  inputs:
    parameters:
      nodes: 10
  service:
    decorators:
      telemetry:
        - system.telemetry.agent
    containers:
      - name: app
        image: rancavil/slurm-master:19.05.5-1
        ports:
          - name: slurmctld
            containerPort: 6817
          - name: slurmd
            containerPort: 6818
          - name: slurmdbd
            containerPort: 6819
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str

            # Replace the number of expected nodes. Also make it start from node-0 instead of node-1.
            sed -i "s/slurmnode\[1-10\]/slurmnode-[0-{{"{{.inputs.parameters.nodes}}"}}]/g" /etc/slurm-llnl/slurm.conf

            # Stupid patch to fix extra line on the master's slurm.conf that make it inconsistent with node's slurm.conf
            sed -i -z 's/#\nNodeName/NodeName/g' /etc/slurm-llnl/slurm.conf

            /etc/slurm-llnl/docker-entrypoint.sh

---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: slurm-node
spec:
  inputs:
    parameters:
      nodes: 10
  service:
    containers:
      - name: app
        image: rancavil/slurm-node:19.05.5-1
        ports:
          - name: slurmd
            containerPort: 6818
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str

            export SLURM_NODENAME=$(hostname)

            # Replace the number of expected nodes. Also make it start from node-0 instead of node-1.
            sed -i "s/slurmnode\[1-10\]/slurmnode-[0-{{"{{.inputs.parameters.nodes}}"}}]/g" /etc/slurm-llnl/slurm.conf

            /etc/slurm-llnl/docker-entrypoint.sh


---
apiVersion: frisbee.dev/v1alpha1
kind: Template
metadata:
  name: slurm-jupyter
spec:
  inputs:
    parameters:
      nodes: 10
  service:
    decorators:
      ingressPort:
        name: http # make the http interface directly visibly outside the cluster.
    containers:
      - name: app
        image: rancavil/slurm-jupyter:19.05.5-1
        ports:
          - name: http
            containerPort: 8888
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str

            # Replace the number of expected nodes. Also make it start from node-0 instead of node-1.
            sed -i "s/slurmnode\[1-10\]/slurmnode-[0-{{"{{.inputs.parameters.nodes}}"}}]/g" /etc/slurm-llnl/slurm.conf

            /etc/slurm-llnl/docker-entrypoint.sh