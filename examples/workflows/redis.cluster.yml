apiVersion: frisbee.io/v1alpha1
kind: Workflow
metadata:
  name: redis-experiment
spec:
  importMonitors: [ "sysmon/container", "redismon/telegraf", "ycsbmon/goycsb" ]
  ingress: localhost

  actions:
    # Instantiate Redis servers
    - actiontype: ServiceGroup
      name: masters
      servicegroup:
        templateRef: rediscluster/master
        instances: 3

    # Create redis cluster
    - actiontype: ServiceGroup
      name: boot
      depends: { running: [ masters ] }
      servicegroup:
        templateRef: rediscluster/bootstrap
        instances: 1
        env:
          servers: .servicegroup.masters.all

    # Ingest keys in parallel into different ranges
    - actiontype: ServiceGroup
      name: loaders
      depends: { running: [ masters ],   complete: [ boot ] }
      servicegroup:
        templateRef: rediscluster/loader
        inputs:
          - { server: .servicegroup.masters.one, offset: "0" }
          - { server: .servicegroup.masters.one, offset: "10000" }
          - { server: .servicegroup.masters.one, offset: "20000" }
          - { server: .servicegroup.masters.one, offset: "30000" }
          - { server: .servicegroup.masters.one, offset: "40000" }
          - { server: .servicegroup.masters.one, offset: "50000" }
          - { server: .servicegroup.masters.one, offset: "60000" }
          - { server: .servicegroup.masters.one, offset: "70000" }
          - { server: .servicegroup.masters.one, offset: "80000" }
          - { server: .servicegroup.masters.one, offset: "90000" }

    # Run queries
    - actiontype: ServiceGroup
      name: runners
      depends: { running: [ masters ], complete: [ loaders ] }
      servicegroup:
        templateRef: rediscluster/runner
        instances: 3
        env:
          server: .servicegroup.masters.one
          workload: workloada

    # Wait queries to stop and shutdown the servers
    - actiontype: Stop
      name: "teardown"
      depends: { complete: [ runners ] }
      stop:


    # Wait until servers are removed
    - actiontype: Wait
      name: "teardown"
      wait:
        complete: [ runners ]