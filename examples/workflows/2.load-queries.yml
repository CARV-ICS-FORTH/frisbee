apiVersion: frisbee.io/v1alpha1
kind: Workflow
metadata:
  name: redis-queries
spec:
  importMonitors: [ "sysmon/container", "redismon/telegraf", "ycsbmon/goycsb" ]
  ingress:
    host: localhost
    useAmbassador: true

  actions:
    # Create a single Master node
    - action: Service
      name: master
      service:
        fromTemplate:
          templateRef: redis/master

    # Ingest keys in parallel, into different ranges
    - action: Cluster
      name: loaders
      depends: { running: [ master ], duration: 30s }
      cluster:
        templateRef: redis/loader
        inputs:
          - { server: .service.master.any, recordcount: "100000", offset: "0" }
          - { server: .service.master.any, recordcount: "100000", offset: "100000" }
          - { server: .service.master.any, recordcount: "100000", offset: "200000" }

    # Run queries
    - action: Cluster
      name: runners
      depends: { running: [ master ], success: [ loaders ] }
      cluster:
        templateRef: redis/runner
        instances: 3
        inputs:
          - { server: .service.master.any, workload: workloada,  operationcount: "300000" }