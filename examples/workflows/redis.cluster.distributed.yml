apiVersion: frisbee.io/v1alpha1
kind: Workflow
metadata:
  name: redis-experiment
spec:
  importMonitors: [ "sysmon/container", "redismon/telegraf", "ycsbmon/goycsb" ]
  ingress: localhost

  actions:
    # Create Redis nodes
    - actiontype: DistributedGroup
      name: masters
      distributedGroup:
        templateRef: rediscluster/master
        instances: 3

    # Create redis cluster
    - actiontype: DistributedGroup
      name: boot
      depends: { running: [ masters ] }
      distributedGroup:
        templateRef: rediscluster/bootstrap
        inputs:
          - { servers: .group.masters.all }

    # Ingest keys in parallel into different ranges
    - actiontype: DistributedGroup
      name: loaders
      depends: { running: [ masters ],   success: [ boot ], duration: 30s }
      distributedGroup:
        templateRef: rediscluster/loader
        inputs:
          - { server: .group.masters.any, recordcount: "100000", offset: "0" }
          - { server: .group.masters.any, recordcount: "100000", offset: "100000" }
          - { server: .group.masters.any, recordcount: "100000", offset: "200000" }
          - { server: .group.masters.any, recordcount: "100000", offset: "300000" }
          - { server: .group.masters.any, recordcount: "100000", offset: "400000" }
          - { server: .group.masters.any, recordcount: "100000", offset: "500000" }
          - { server: .group.masters.any, recordcount: "100000", offset: "600000" }
          - { server: .group.masters.any, recordcount: "100000", offset: "700000" }
          - { server: .group.masters.any, recordcount: "100000", offset: "800000" }
          - { server: .group.masters.any, recordcount: "100000", offset: "900000" }

    # Run queries
    - actiontype: DistributedGroup
      name: runners
      depends: { running: [ masters ], success: [ loaders ] }
      distributedGroup:
        templateRef: rediscluster/runner
        instances: 5
        inputs:
          - { server: .group.masters.any, workload: workloada,  operationcount: "1000000" }


    # Wait until servers are removed
    - actiontype: Wait
      name: "teardown"
      wait:
        success: [ runners ]