apiVersion: frisbee.io/v1alpha1
kind: Workflow
metadata:
  name: redis-failover
spec:
  importMonitors: [ "sysmon/container", "redismon/telegraf", "ycsbmon/goycsb"]
  ingress: localhost

  actions:
    # Create a Master node
    - actiontype: ServiceGroup
      name: masters
      servicegroup:
        templateRef: redis/master
        instances: 1

    # Create a Slave node
    - actiontype: ServiceGroup
      name: slaves
      depends: { running: [ masters ] }
      servicegroup:
        templateRef: redis/slave
        inputs:
          - { master: .servicegroup.masters.one }


    # Create a failover manager
    - actiontype: ServiceGroup
      name: sentinel
      depends: { running: [ masters, slaves ] }
      servicegroup:
        templateRef: redis/sentinel
        inputs:
          - { master: .servicegroup.masters.one }


    # Ingest keys in parallel into different ranges
    - actiontype: ServiceGroup
      name: loaders
      depends: { running: [ masters ] }
      servicegroup:
        templateRef: redis/loader
        inputs:
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "0" }
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "100000" }
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "200000" }
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "300000" }
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "400000" }
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "500000" }
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "600000" }
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "700000" }
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "800000" }
          - { server: .servicegroup.masters.one, recordcount: "100000", offset: "900000" }

    # Run queries
    - actiontype: ServiceGroup
      name: runners
      depends: { running: [ masters ], complete: [ loaders ] }
      servicegroup:
        templateRef: redis/runner
        instances: 5
        inputs:
          - { server: .servicegroup.masters.one, workload: workloada,  operationcount: "1000000"}


    # Stop the master nodes after a few minutes
    - actiontype: Stop
      name: "teardown"
      #depends: {duration: 1m}
      stop:
        macro: .servicegroup.runners.all
        schedule:
          cron: "@every 1m"

    # Wait until servers are removed
    - actiontype: Wait
      name: "terminate"
      wait:
        complete: [ masters ]