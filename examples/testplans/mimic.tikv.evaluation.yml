# This workflow mimic the official TikV evaluation workflow.
# https://tikv.org/docs/5.1/deploy/performance/instructions/
apiVersion: frisbee.io/v1alpha1
kind: Workflow
metadata:
  name: mimic-tikv
spec:
  importMonitors: [ "sysmon/container", "ycsbmon/client" ]
  ingress:
    host: platform.science-hangar.eu

  testOracle:
    pass: >-
      {{.IsSuccessful "runners"}} == true

  actions:
    # PD Hardware Configuration: CPU: 4 cores, Memory: 8GB, Storage: SAS/200GB,
    - action: Service
      name: master
      service:
        fromTemplate:
          templateRef: tikv/placementDriver

    # Worker Hardware Configuration: CPU: 8 cores, 32 GB, Storage: SSD/200GB
    - action: Cluster
      depends: { running: [ master ] }
      name: workers
      cluster:
        templateRef: tikv/worker
        instances: 3
        inputs:
          - { placementDriver: .service.master.any }


    # YCSB Hardware Configuration: CPU: 8 cores, 32 GB, Storage: XX
    - action: Service
      depends: { running: [ workers ], after : "1m" }
      name: loader
      service:
        fromTemplate:
          templateRef: ycsb-tikv/loader
          inputs:
            { server: .service.master.any }