# Example for point to point communication
---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: direct
spec:
  services:
    "server":
      container:
        name: app
        image: "networkstatic/iperf3"
        ports:
          - name: tcp
            containerPort: 5201
        args: [ "-s", "-f", "m" ]

    "client":
      container:
        name: app
        image: "networkstatic/iperf3"
        env:
          - name: server
        command:
          - /bin/sh # Run shell
          - -c # Read from string
          - |  # Multi-line str
            set -eum
            trap "touch /dev/shm/stop" EXIT

            #sleep 10 # Wait for NIC
            iperf3 -c ${server} -t 600 -f m > /dev/shm/pipe


---
apiVersion: frisbee.io/v1alpha1
kind: Workflow
metadata:
  name: mesh-1server-1client
spec:
  actions:
    # Create a server node
    - actiontype: ServiceGroup
      name: servers
      servicegroup:
        templateRef: direct/server
        instances: 1

    # Create a client node
    - actiontype: ServiceGroup
      name: clients
      depends: { running: [ servers ] }
      servicegroup:
        templateRef: direct/client
        inputs:
          - { server: .servicegroup.servers.one }


    # Wait until servers are removed
    - actiontype: Wait
      name: "terminate"
      wait:
        duration: 1h
