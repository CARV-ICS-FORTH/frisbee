#
# Consumer
#
---
apiVersion: frisbee.io/v1alpha1
kind: DataPort
metadata:
  name: consumer
spec:
  type: input
  input:
    selector:
      match:
        labels:
          "arkoudes": "kados"
      mode: one
  protocol: direct
  direct:
    spec:
      port: 5201


---
apiVersion: frisbee.io/v1alpha1
kind: Service
metadata:
  name: server
spec:
  addPorts: [consumer]
  container:
    name: app
    image: "networkstatic/iperf3"
    args: [ "-s", "-f", "m" ]

---
#
# Producer
#
---
apiVersion: frisbee.io/v1alpha1
kind: DataPort
metadata:
  name: producer
  labels:
    "arkoudes": "kados"
spec:
  type: output
  protocol: direct

---

apiVersion: frisbee.io/v1alpha1
kind: Service
metadata:
  name: client
spec:
  addPorts: [producer]
  container:
    name: app
    image: "networkstatic/iperf3"
    env:
      - name: server
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['discover.producer.dst']
            # This will get the server from annotations and will use it as execution argument
    command:
      - /bin/sh # Run shell
      - -c # Read from string
      - |  # Multi-line str
        set -eum
        trap "touch /dev/shm/stop" EXIT

        #sleep 10 # Wait for NIC
        iperf3 -c ${server} -t 600 -f m > /dev/shm/pipe