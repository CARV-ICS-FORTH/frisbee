#
# Consumer
#
---
apiVersion: frisbee.io/v1alpha1
kind: DataPort
metadata:
  name: consumer
spec:
  type: input
  input:
    selector:
      matchLabels:
        "lala": "kados"
  protocol: direct
  direct:
    dstAddr: server
    dstPort: 5201


---
apiVersion: frisbee.io/v1alpha1
kind: Service
metadata:
  name: server
spec:
  addPorts: [ consumer ]

  container:
    name: app
    image: "networkstatic/iperf3"
    env:
      - name: port
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['ports.consumer.direct.LocalPort']
    command:
      - /bin/sh # Run shell
      - -c # Read from string
      - |  # Multi-line str
        set -eum
        trap "touch /dev/shm/stop" EXIT


        echo "Connect to ${port}"
        iperf3 -s -f m -p ${port}

---
#
# Producer
#
---
apiVersion: frisbee.io/v1alpha1
kind: DataPort
metadata:
  name: producer
  labels:
    "lala": "kados"
spec:
  type: output
  protocol: direct

---

apiVersion: frisbee.io/v1alpha1
kind: Service
metadata:
  name: client
spec:
  addPorts: [ producer ]

  container:
    name: app
    image: "networkstatic/iperf3"
    env:
      - name: server
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['ports.producer.direct.RemoteAddr']
      - name: port
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['ports.producer.direct.RemotePort']
            # This will get the server from annotations and will use it as execution argument
    command:
      - /bin/sh # Run shell
      - -c # Read from string
      - |  # Multi-line str
        set -eum
        trap "touch /dev/shm/stop" EXIT

        echo "Connect to ${server}:${port}"
        iperf3 -c ${server} -p ${port} -t 600 -f m > /dev/shm/pipe