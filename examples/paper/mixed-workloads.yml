---
apiVersion: frisbee.io/v1alpha1
kind: TestPlan
metadata:
  name: redis-mixed-workloads
spec:
  importDashboards:
    - system.telemetry.agent
    - redis.telemetry.server
    - ycsb.telemetry.client

  testOracle:
    pass: >-
      {{.IsSuccessful "runners"}} == true

  actions:
    # Create a single Master node
    - action: Service
      name: master
      service:
        
        templateRef: redis.single.master

    # Ingest keys in parallel, into different ranges
    - action: Cluster
      name: "loaders"
      depends: { running: [ master ] }
      cluster:
        templateRef: ycsb.redis.loader
        inputs:
          - { server: .service.master.one, recordcount: "1000000", offset: "0" }
          - { server: .service.master.one, recordcount: "1000000", offset: "1000000" }
          - { server: .service.master.one, recordcount: "1000000", offset: "2000000" }

    # Wait for ingestion to complete, and start querying clients, with different workloads
    - action: Cluster
      name: "runners"
      depends: { running: [ master ], success: [ loaders ] }
      cluster:
        templateRef: ycsb.redis.runner
        inputs:
          - { server: .service.master.one, workload: workloada, operationcount: "1000000" }
          - { server: .service.master.one, workload: workloadb, operationcount: "1000000" }
          - { server: .service.master.one, workload: workloadc, operationcount: "1000000" }
          - { server: .service.master.one, workload: workloadd, operationcount: "1000000" }
          - { server: .service.master.one, workload: workloada, operationcount: "1000000" }
        schedule:
          cron: "@every 2m"
