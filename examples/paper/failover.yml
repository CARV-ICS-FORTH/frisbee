apiVersion: frisbee.io/v1alpha1
kind: Workflow
metadata:
  name: redis-failover
spec:
  importMonitors: [ "sysmon/container", "redismon/telegraf", "ycsbmon/goycsb" ]
  ingress: localhost

  actions:
    # Create a Master node
    - actiontype: DistributedGroup
      name: masters
      distributedGroup:
        templateRef: redis/master
        instances: 1

    # Create a Slave node
    - actiontype: DistributedGroup
      name: slaves
      depends: { running: [ masters ] }
      distributedGroup:
        templateRef: redis/slave
        inputs: # parameters to template ENV variables
          - { master: .group.masters.one }


    # Create a failover manager
    - actiontype: DistributedGroup
      name: sentinel
      depends: { running: [ masters, slaves ] }
      distributedGroup:
        templateRef: redis/sentinel
        inputs:
          - { master: .group.masters.one }


    # Ingest keys in parallel into different ranges
    - actiontype: DistributedGroup
      name: loaders
      depends: { running: [ masters ] }
      distributedGroup:
        templateRef: redis/loader
        inputs:
          - { server: .group.masters.one, recordcount: "100000000", offset: "0" }


    # Cause two partition failures with different duration
    - actiontype: Chaos
      name: partition0
      depends: { running: [ masters ], duration: "5m" }
      chaos:
        type: partition
        partition:
          selector:
            macro: .group.masters.one
          duration: "2m"

    - actiontype: Chaos
      name: partition1
      depends: { running: [ masters ], success: [ partition0 ], duration: "3m" }
      chaos:
        type: partition
        partition:
          selector: { macro: .group.masters.one }
          duration: "2m"


    # Stop the master nodes after a few minutes
    - actiontype: Stop
      name: "teardown"
      depends: { success: [ partition1 ], duration: "1m" }
      stop:
        selector: { macro: .group.runners.all }

    # Wait until servers are removed
    - actiontype: Wait
      name: "terminate"
      wait:
        success: [ masters ]