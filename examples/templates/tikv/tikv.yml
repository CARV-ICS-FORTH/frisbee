---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: tikv-pvc
spec:
  storageClassName: shared-ssd-storage
  resources:
    requests:
      storage: 200Gi
  accessModes:
    - ReadWriteMany


# In some situations such as in the Docker or NAT network environment, if the other nodes (peers) cannot access
# the PD node through the default peer URLs listened to by this PD node, you must manually set the advertise peer URLs.
---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: tikv
spec:
  entries:
    "placementDriver": # Placement Driver
      inputs:
        parameters:
          cpu: ""
          memory: ""
      spec: |
        agents:                                 # Agents
          telemetry: [ sysmon/container ]
        volumes:                                # Volumes
          - name: datastore
            persistentVolumeClaim:
              claimName: tikv-pvc
        resources:                              # Resources
          cpu: {{.Inputs.Parameters.cpu}}
          memory: {{.Inputs.Parameters.memory}}
        container:                              # Container
          name: app
          image: pingcap/pd:v5.1.2
          volumeMounts:
            - name: datastore
              mountPath: /store
          ports:
            - name: to-clients
              containerPort: 2379
            - name: to-cluster
              containerPort: 2380
          command:
            - /bin/sh   # Run shell
            - -c        # Read from string
            - |         # Multi-line str
              set -eum
              trap "touch /dev/shm/stop" EXIT

              rm -rf /store/$${HOSTNAME}
              mkdir -p /store/$${HOSTNAME}/pd

              echo "Start PD server at $${HOSTNAME}}"

              /pd-server                                                  \
              --client-urls=http://0.0.0.0:2379                           \
              --advertise-client-urls=http://$${HOSTNAME}:2379            \
              --peer-urls=http://0.0.0.0:2380                             \
              --advertise-peer-urls=http://$${HOSTNAME}:2380              \
              --data-dir=/store/$${HOSTNAME}/pd

    "worker": # Service node
      inputs:
        parameters:
          placementDriver: "localhost"
          cpu: ""
          memory: ""
      spec: |
        agents:                                 # Agents
          telemetry: [ sysmon/container ]
        volumes:                                # Volumes
          - name: datastore
            persistentVolumeClaim:
              claimName: tikv-pvc
        resources:                              # Resources
          cpu: {{.Inputs.Parameters.cpu}}
          memory: {{.Inputs.Parameters.memory}}
        container:                              # Container
          name: app
          image: pingcap/tikv:v5.1.2
          volumeMounts:
            - name: datastore
              mountPath: /store
          ports:
            - name: worker-port
              containerPort: 20160
          command:
            - /bin/sh   # Run shell
            - -c        # Read from string
            - |         # Multi-line str
              set -eum
              trap "touch /dev/shm/stop" EXIT

              # increase the maximum number of open file descriptors
              ulimit -n 82920

              pd={{.Inputs.Parameters.placementDriver}}

              echo " HOST $${HOSTNAME}"
              sleep 1200

              rm -rf /store/$${HOSTNAME}
              mkdir -p /store/$${HOSTNAME}/data

              echo "Contact: ${pd}:2379 and start TIVK at /store/$${HOSTNAME}/data"
              /tikv-server                                                \
                --addr=0.0.0.0:20160                                      \
                --advertise-addr=$${HOSTNAME}:20160                       \
                --pd=${pd}:2379                                           \
                --data-dir=/store/$${HOSTNAME}/data