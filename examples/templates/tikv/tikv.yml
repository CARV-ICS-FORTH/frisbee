---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: tikv
spec:
  entries:
    "placementDriver": # Placement Driver
      inputs:
        parameters:
          port: "2379"
      spec: |
        agents:
          telemetry: [ sysmon/container ]
        container:
          name: app
          image: pingcap/pd:latest
          ports:
            - name: to-clients
              containerPort: 2379
            - name: to-cluster
              containerPort: 2380
          command:
            - /bin/sh   # Run shell
            - -c        # Read from string
            - |         # Multi-line str
              set -eum
              trap "touch /dev/shm/stop" EXIT

              # Start server in the foreground
              /pd-server                                                  \
              --client-urls=http://0.0.0.0:2379                           \
              --peer-urls=http://0.0.0.0:2380                             \
              --advertise-client-urls=http://$${HOSTNAME}:2379            \
              --advertise-peer-urls=http://$${HOSTNAME}:2380              \
              --data-dir=/data/pd/$${HOSTNAME}.bin


    "worker": # Service node
      inputs:
        parameters:
          placementDriver: "localhost"
      spec: |
        agents:
          telemetry: [ sysmon/container ]
        resources:
        container:
          name: app
          image: pingcap/tikv:latest
          ports:
            - name: worker-port
              containerPort: 20160
          command:
            - /bin/sh   # Run shell
            - -c        # Read from string
            - |         # Multi-line str
              set -eum
              trap "touch /dev/shm/stop" EXIT

              # increase the maximum number of open file descriptors
              ulimit -n 82920

              manager={{.Inputs.Parameters.placementDriver}}

              echo "Start TIKV Server and contact $manager"
              /tikv-server                                                \
                --addr=0.0.0.0:20160                                      \
                --pd=${manager}:2379                                      \
                --advertise-addr=$${HOSTNAME}:20160                       \
                --data-dir=/data/store/$${HOSTNAME}.bin