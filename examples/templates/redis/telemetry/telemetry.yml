---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: redismon
spec:
  entries:
    "server":
      spec: |
        agent:
          container:
            name: telegraf
            image: telegraf:1.20.3
            ports:
              - name: mon-redis
                containerPort: 9443
            command:
              - /bin/sh # Run shell
              - -c # Read from string
              - |  # Multi-line str
                set -eum

                cat > /tmp/redis.conf <<EOF
                [[inputs.redis]]
                   servers = ["tcp://localhost:6379"]

                [[outputs.prometheus_client]]
                   listen = ":9443"
                   metric_version = 2
                   collectors_exclude = ["gocollector","process"]
                EOF

                telegraf --config /tmp/redis.conf &

                # When the stop file is added by the container, the process stop
                while [ ! -f "/dev/shm/stop" ];
                do
                  sleep 10
                done

        dashboards:
          matchlabels:
            dashboard: redis