---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: fio-pvc
spec:
  storageClassName: ssd-storage
  resources:
    requests:
      storage: 5Gi
  accessModes:
    - ReadWriteOnce

---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: fio
spec:
  entries:
    "benchmark":
      inputs:
        parameters:
          device: "/mnt/fio-benchmark-exporter"
          size: "10G"
          direct: "0"
      spec: |
        agents:
          telemetry: [ sysmon/container ]
        volumes:
          - name: fio-benchmark-exporter-pv
            persistentVolumeClaim:
              claimName: fio-pvc
        container:
          name: app
          image: xridge/fio
          volumeMounts:
            - name: fio-benchmark-exporter-pv
              mountPath: /mnt/fio-benchmark-exporter
          command:
            - /bin/sh # Run shell
            - -c      # Read from string
            - |       # Multi-line str
              set -eum
              trap "touch /dev/shm/stop" EXIT

              DEVICE={{.Inputs.Parameters.device}}
              SIZE={{.Inputs.Parameters.size}}
              DIRECT={{.Inputs.Parameters.direct}}

              echo "USING DEVICE: $DEVICE"

              cat > fio.conf <<EOF
              [global]
              directory=$DEVICE
              size=$SIZE
              direct=$DIRECT
              gtod_reduce=1
              time_based=1
              runtime=1m
              group_reporting=1

              [file1]
              ioengine=libaio
              EOF

              for rw in randread randwrite; do
                  for numjobs in 1 4 8 16; do
                      for iodepth in 1 4 32 128; do
                          cmd="fio --rw=$$rw --bs=4K --numjobs=$$numjobs --iodepth=$$iodepth fio.conf"
                          echo $$cmd
                          $$cmd >> /output

                          echo
                          echo
                          echo
                      done
                  done
              done
              for rw in read write; do
                  for numjobs in 1; do
                      for iodepth in 1 4 32 128 256; do
                          cmd="fio --rw=$$rw --bs=1M --numjobs=$$numjobs --iodepth=$$iodepth fio.conf"
                          echo $$cmd
                          $$cmd >> /output

                          echo
                          echo
                          echo
                      done
                  done
              done