---
apiVersion: frisbee.io/v1alpha1
kind: Template
metadata:
  name: redis-example
spec:
  services:
    "server":
      image: redis
      ports:
        - port: 6379
          name: to-clients
      command:
        - /bin/sh   # Run shell
        - -c        # Read from string
        - |         # Multi-line str
          set -eum
          trap "touch /dev/shm/stop" EXIT

          redis-server  --port 6379 --appendonly yes

    "loader":
      image: aylei/go-ycsb:20201029
      env:
        - name: host
        - name: offset
      command:
        - /bin/sh   # Run shell
        - -c        # Read from string
        - |         # Multi-line str
          set -eum
          trap "touch /dev/shm/stop" EXIT

          echo Loader: insert keys into $host @ "$offset"
          ./go-ycsb load redis                                    \
                  -p recordcount=1000000                          \
                  -p insertstart="$offset"                        \
                  -p threadcount=32                               \
                  -p redis.mode="single"                          \
                  -p redis.addr="$host:6379"                      \
          >> /dev/shm/pipe

    "runner":
      image: aylei/go-ycsb:20201029
      env:
        - name: host
        - name: workload
      command:
        - /bin/sh   # Run shell
        - -c        # Read from string
        - |         # Multi-line str
          set -eum
          trap "touch /dev/shm/stop" EXIT

          echo Runner: run $workload to $host
          ./go-ycsb run redis                         \
                    -P workloads/$workload            \
                    -p operationcount=10000000        \
                    -p threadcount=32                 \
                    -p redis.mode="single"            \
                    -p redis.addr="$host:6379"        \
          >> /dev/shm/pipe



---
apiVersion: frisbee.io/v1alpha1
kind: Workflow
metadata:
  name: redis-experiment
spec:
  actions:
    - actiontype: CreateGroup
      name: masters
      createServiceGroup:
        templateRef: redis-example/server
        instances: 3

    - actiontype: CreateGroup
      name: loaders
      depends: { ready: [ masters ] }
      createServiceGroup:
        templateRef: redis-example/loader
        inputs:
          - { host: .servicegroup.masters.one, offset: "0" }
          - { host: .servicegroup.masters.one, offset: "1000000" }
          - { host: .servicegroup.masters.one, offset: "2000000" }
          - { host: .servicegroup.masters.one, offset: "3000000" }
          - { host: .servicegroup.masters.one, offset: "4000000" }
          - { host: .servicegroup.masters.one, offset: "5000000" }
          - { host: .servicegroup.masters.one, offset: "6000000" }
          - { host: .servicegroup.masters.one, offset: "7000000" }
          - { host: .servicegroup.masters.one, offset: "8000000" }
          - { host: .servicegroup.masters.one, offset: "9000000" }

    - actiontype: CreateGroup
      name: runners
      depends: { ready: [ masters ], complete: [ loaders ] }
      createServiceGroup:
        templateRef: redis-example/runner
        instances: 3
        env:
          host: .servicegroup.masters.one
          workload: workloada